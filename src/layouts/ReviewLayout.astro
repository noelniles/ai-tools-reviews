---
import type { CollectionEntry } from 'astro:content'
import BaseLayout from './BaseLayout.astro'
import Nav from '../components/Nav.astro'
import RatingStars from '../components/RatingStars.astro'
import { analytics } from '../lib/analytics'

interface Props {
  entry: CollectionEntry<'reviews'>
  Content: any
}

const { entry, Content } = Astro.props
const { title, description, date, rating, affiliate_links, tags } = entry.data
const toolName = title.replace(' Review', '');
---

<BaseLayout title={title} description={description}>
  <Nav />

  <article class="max-w-3xl mx-auto">
    <!-- Header -->
    <header class="mb-8 space-y-4">
      <div class="flex flex-wrap gap-2 mb-3">
        {tags?.map((tag) => (
          <span class="text-xs px-2 py-1 rounded-full bg-slate-800 text-slate-300">
            {tag}
          </span>
        ))}
      </div>
      
      <h1 class="text-4xl font-bold tracking-tight">{title}</h1>
      
      <div class="flex items-center gap-4 text-sm text-slate-400">
        <time datetime={date}>
          {new Date(date).toLocaleDateString('en-US', { 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
          })}
        </time>
        <span>•</span>
        <div class="flex items-center gap-2">
          <RatingStars score={rating.overall} />
          <span class="font-semibold text-brand">{rating.overall}/10</span>
        </div>
      </div>

      <!-- Affiliate CTA -->
      {affiliate_links?.primary && (
        <div class="mt-6 p-4 rounded-xl bg-gradient-to-r from-brand/20 to-purple-500/20 border border-brand/30">
          <div class="flex items-center justify-between gap-4">
            <div>
              <p class="font-semibold text-white mb-1">Try {toolName}</p>
              <p class="text-xs text-slate-300">Click below to get started</p>
            </div>
            <a 
              href={affiliate_links.primary}
              target="_blank"
              rel="noopener noreferrer sponsored"
              class="affiliate-link px-6 py-2.5 bg-brand hover:bg-brand/80 text-white rounded-lg font-semibold transition-colors whitespace-nowrap"
              data-affiliate="true"
              data-tool={toolName}
            >
              Visit Site →
            </a>
          </div>
        </div>
      )}
    </header>

    <!-- Rating Breakdown -->
    {(rating.usability || rating.quality || rating.pricing) && (
      <div class="mb-8 p-6 rounded-xl bg-slate-900/40 border border-slate-800">
        <h3 class="text-sm font-semibold mb-4 text-slate-400 uppercase tracking-wide">Rating Breakdown</h3>
        <div class="grid gap-3">
          {rating.usability && (
            <div class="flex items-center justify-between">
              <span class="text-sm text-slate-300">Usability</span>
              <div class="flex items-center gap-2">
                <RatingStars score={rating.usability} size="sm" />
                <span class="text-sm font-semibold w-8">{rating.usability}/10</span>
              </div>
            </div>
          )}
          {rating.quality && (
            <div class="flex items-center justify-between">
              <span class="text-sm text-slate-300">Quality</span>
              <div class="flex items-center gap-2">
                <RatingStars score={rating.quality} size="sm" />
                <span class="text-sm font-semibold w-8">{rating.quality}/10</span>
              </div>
            </div>
          )}
          {rating.pricing && (
            <div class="flex items-center justify-between">
              <span class="text-sm text-slate-300">Pricing</span>
              <div class="flex items-center gap-2">
                <RatingStars score={rating.pricing} size="sm" />
                <span class="text-sm font-semibold w-8">{rating.pricing}/10</span>
              </div>
            </div>
          )}
        </div>
      </div>
    )}

    <!-- Content -->
    <div class="prose-custom max-w-none">
      <Content />
    </div>

    <!-- Bottom Affiliate CTA -->
    {affiliate_links?.primary && (
      <div class="mt-12 p-6 rounded-xl bg-slate-900/60 border border-slate-800 text-center">
        <p class="text-lg font-semibold mb-3">Ready to try {toolName}?</p>
        <a 
          href={affiliate_links.primary}
          target="_blank"
          rel="noopener noreferrer sponsored"
          class="affiliate-link inline-block px-8 py-3 bg-brand hover:bg-brand/80 text-white rounded-lg font-semibold transition-colors"
          data-affiliate="true"
          data-tool={toolName}
        >
          Get Started →
        </a>
        <p class="text-xs text-slate-500 mt-3">This is an affiliate link. We may earn a commission.</p>
      </div>
    )}
  </article>
  
  <!-- Track Review View -->
  <script define:vars={{ toolName, rating: rating.overall }}>
    // Track that user viewed this review
    if (typeof gtag !== 'undefined') {
      gtag('event', 'review_view', {
        tool_name: toolName,
        rating: rating,
      });
    }
  </script>
</BaseLayout>

<style is:global>
  .prose-custom {
    line-height: 1.625;
    color: #cbd5e1;
  }
  
  /* Hide the first H1 since it's already in the header */
  .prose-custom > h1:first-child {
    display: none;
  }
  
  .prose-custom h1 {
    font-size: 2.25rem;
    line-height: 2.5rem;
    font-weight: 700;
    color: #f1f5f9;
    margin-top: 0;
    margin-bottom: 1.5rem;
  }
  .prose-custom h2 {
    font-size: 1.875rem;
    line-height: 2.25rem;
    font-weight: 700;
    color: #f1f5f9;
    margin-top: 4rem;
    margin-bottom: 1.5rem;
    padding-bottom: 0.75rem;
    border-bottom: 2px solid #334155;
  }
  .prose-custom h3 {
    font-size: 1.5rem;
    line-height: 2rem;
    font-weight: 600;
    color: #f1f5f9;
    margin-top: 2.5rem;
    margin-bottom: 1rem;
  }
  .prose-custom h4 {
    font-size: 1.25rem;
    line-height: 1.75rem;
    font-weight: 600;
    color: #f1f5f9;
    margin-top: 2rem;
    margin-bottom: 0.75rem;
  }
  .prose-custom p {
    margin-bottom: 1.5rem;
    line-height: 2rem;
    font-size: 1rem;
    color: #cbd5e1;
  }
  .prose-custom ul, .prose-custom ol {
    margin-top: 1.5rem;
    margin-bottom: 1.5rem;
    margin-left: 1.5rem;
  }
  .prose-custom li {
    margin-bottom: 0.75rem;
    line-height: 2rem;
    color: #cbd5e1;
  }
  .prose-custom strong {
    color: #f1f5f9;
    font-weight: 600;
  }
  .prose-custom a {
    color: #0ea5e9;
    text-decoration: none;
  }
  .prose-custom a:hover {
    text-decoration: underline;
  }
  .prose-custom code {
    background-color: #1e293b;
    color: #0ea5e9;
    padding: 0.125rem 0.375rem;
    border-radius: 0.25rem;
    font-size: 0.875rem;
  }
  .prose-custom pre {
    background-color: #0f172a;
    border: 1px solid #1e293b;
    border-radius: 0.5rem;
    padding: 1rem;
    overflow-x: auto;
    margin-top: 1.5rem;
    margin-bottom: 1.5rem;
  }
  .prose-custom blockquote {
    border-left: 4px solid #0ea5e9;
    padding-left: 1.5rem;
    font-style: italic;
    color: #94a3b8;
    margin-top: 2rem;
    margin-bottom: 2rem;
  }
  
  /* Add space before/after special components */
  .prose-custom > div {
    margin-top: 2.5rem;
    margin-bottom: 2.5rem;
  }
  
  /* Tables */
  .prose-custom table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 2rem;
    margin-bottom: 2rem;
  }
  .prose-custom th {
    background-color: #1e293b;
    color: #f1f5f9;
    font-weight: 600;
    padding: 0.75rem;
    text-align: left;
  }
  .prose-custom td {
    border-bottom: 1px solid #334155;
    padding: 0.75rem;
    color: #cbd5e1;
  }
</style>