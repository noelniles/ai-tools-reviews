---
import type { CollectionEntry } from 'astro:content'
import BaseLayout from './BaseLayout.astro'
import Nav from '../components/Nav.astro'
import RatingStars from '../components/RatingStars.astro'
import AuthorByline from '../components/AuthorByline.astro'
import { analytics } from '../lib/analytics'

interface Props {
  entry: CollectionEntry<'reviews'>
  Content: any
}

const { entry, Content } = Astro.props
const { title, description, date, rating, affiliate_links, tags } = entry.data
// Extract tool name from title (e.g., "Replicate Review 2026: ..." -> "Replicate")
const toolName = title.split(' Review')[0];
---

<BaseLayout 
  title={title} 
  description={description}
  type="article"
  publishedTime={date}
  keywords={tags}
>
  <!-- Schema.org Structured Data for Reviews -->
  <script type="application/ld+json" slot="head" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "Review",
    "itemReviewed": {
      "@type": "SoftwareApplication",
      "name": toolName,
      "applicationCategory": "AI Tool",
      "operatingSystem": "Web",
      "offers": affiliate_links?.primary ? {
        "@type": "Offer",
        "url": affiliate_links.primary,
        "priceCurrency": "USD"
      } : undefined
    },
    "author": {
      "@type": "Organization",
      "name": "AI Tools Reviews",
      "url": "https://aitoolsreviews.com"
    },
    "datePublished": date,
    "reviewRating": {
      "@type": "Rating",
      "ratingValue": rating.overall,
      "bestRating": 10,
      "worstRating": 0
    },
    "reviewBody": description
  })} />

  <Nav />

  <article class="max-w-3xl mx-auto">
    <!-- Header -->
    <header class="mb-8 space-y-4">
      <div class="flex flex-wrap gap-2 mb-3">
        {tags?.map((tag) => (
          <span class="text-xs px-2 py-1 rounded-full bg-slate-800 text-slate-300">
            {tag}
          </span>
        ))}
      </div>
      
      <h1 class="text-4xl font-bold tracking-tight">{title}</h1>
      
      <AuthorByline date={date} readTime="8 min read" />
      
      <div class="flex items-center gap-4 text-sm text-slate-400">
        <div class="flex items-center gap-2">
          <RatingStars score={rating.overall} />
          <span class="font-semibold text-brand">{rating.overall}/10</span>
        </div>
      </div>

      <!-- Affiliate CTA -->
      {affiliate_links?.primary && (
        <div class="mt-6 p-4 rounded-xl bg-gradient-to-r from-brand/20 to-purple-500/20 border border-brand/30">
          <div class="flex items-center justify-between gap-4">
            <div>
              <p class="font-semibold text-white mb-1">Try {toolName}</p>
              <p class="text-xs text-slate-300">Click below to get started</p>
            </div>
            <a 
              href={affiliate_links.primary}
              target="_blank"
              rel="noopener noreferrer sponsored"
              class="affiliate-link px-6 py-2.5 bg-brand hover:bg-brand/80 text-white rounded-lg font-semibold transition-colors whitespace-nowrap"
              data-affiliate="true"
              data-tool={toolName}
            >
              Visit Site →
            </a>
          </div>
        </div>
      )}
    </header>

    <!-- Rating Breakdown -->
    {(rating.usability || rating.quality || rating.pricing) && (
      <div class="mb-8 p-6 rounded-xl bg-slate-900/40 border border-slate-800">
        <h3 class="text-sm font-semibold mb-4 text-slate-400 uppercase tracking-wide">Rating Breakdown</h3>
        <div class="grid gap-3">
          {rating.usability && (
            <div class="flex items-center justify-between">
              <span class="text-sm text-slate-300">Usability</span>
              <div class="flex items-center gap-2">
                <RatingStars score={rating.usability} size="sm" />
                <span class="text-sm font-semibold w-8">{rating.usability}/10</span>
              </div>
            </div>
          )}
          {rating.quality && (
            <div class="flex items-center justify-between">
              <span class="text-sm text-slate-300">Quality</span>
              <div class="flex items-center gap-2">
                <RatingStars score={rating.quality} size="sm" />
                <span class="text-sm font-semibold w-8">{rating.quality}/10</span>
              </div>
            </div>
          )}
          {rating.pricing && (
            <div class="flex items-center justify-between">
              <span class="text-sm text-slate-300">Pricing</span>
              <div class="flex items-center gap-2">
                <RatingStars score={rating.pricing} size="sm" />
                <span class="text-sm font-semibold w-8">{rating.pricing}/10</span>
              </div>
            </div>
          )}
        </div>
      </div>
    )}

    <!-- Technical Deep-Dive Callout -->
    <div class="mb-8 p-6 bg-gradient-to-br from-purple-900/20 to-blue-900/20 border border-purple-500/30 rounded-xl">
      <div class="flex items-start gap-4">
        <div class="p-3 bg-purple-500/20 rounded-lg">
          <svg class="w-6 h-6 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"/>
          </svg>
        </div>
        <div class="flex-1">
          <h3 class="text-lg font-semibold mb-2 text-white">Want to understand how this works?</h3>
          <p class="text-sm text-slate-300 mb-4">
            Dive into the technical architecture, algorithms, and implementation details behind {toolName}.
          </p>
          <div class="flex flex-wrap gap-3">
            <a href="/technical/transformer-architecture" class="inline-flex items-center gap-2 px-4 py-2 bg-purple-500/20 hover:bg-purple-500/30 border border-purple-500/40 rounded-lg text-sm font-semibold transition-colors">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
              </svg>
              Transformer Architecture
            </a>
            <a href="/technical/attention-mechanisms" class="inline-flex items-center gap-2 px-4 py-2 bg-purple-500/20 hover:bg-purple-500/30 border border-purple-500/40 rounded-lg text-sm font-semibold transition-colors">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
              </svg>
              Attention Mechanisms
            </a>
            <a href="/technical/long-context-architecture" class="inline-flex items-center gap-2 px-4 py-2 bg-purple-500/20 hover:bg-purple-500/30 border border-purple-500/40 rounded-lg text-sm font-semibold transition-colors">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"/>
              </svg>
              Long-Context Models
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- Content -->
    <div class="prose prose-invert prose-slate max-w-none
                prose-headings:font-bold prose-headings:text-slate-100
                prose-h1:text-3xl prose-h1:mb-6
                prose-h2:text-2xl prose-h2:mt-12 prose-h2:mb-5 prose-h2:border-b prose-h2:border-slate-700/50 prose-h2:pb-2
                prose-h3:text-xl prose-h3:mt-8 prose-h3:mb-4 prose-h3:text-slate-200
                prose-h4:text-lg prose-h4:mt-6 prose-h4:mb-3 prose-h4:text-slate-300
                prose-p:text-slate-300 prose-p:leading-7 prose-p:mb-5
                prose-a:text-brand prose-a:no-underline hover:prose-a:underline
                prose-strong:text-slate-100 prose-strong:font-semibold
                prose-code:text-purple-400 prose-code:bg-slate-900/50 prose-code:px-1.5 prose-code:py-0.5 prose-code:rounded prose-code:text-sm
                prose-pre:bg-slate-900/80 prose-pre:border prose-pre:border-slate-800 prose-pre:rounded-lg prose-pre:my-5 prose-pre:p-4
                prose-ul:text-slate-300 prose-ul:my-5 prose-ul:pl-6 prose-ul:space-y-2
                prose-ol:text-slate-300 prose-ol:my-5 prose-ol:space-y-2
                prose-li:text-slate-300 prose-li:leading-7 prose-li:pl-1
                prose-li:marker:text-brand
                prose-blockquote:border-brand prose-blockquote:text-slate-300 prose-blockquote:my-5 prose-blockquote:py-1
                prose-img:rounded-xl prose-img:border prose-img:border-slate-800 prose-img:my-6
                prose-hr:border-slate-700 prose-hr:my-10">
      <Content />
    </div>

    <!-- Bottom Affiliate CTA -->
    {affiliate_links?.primary && (
      <div class="mt-12 p-6 rounded-xl bg-slate-900/60 border border-slate-800 text-center">
        <p class="text-lg font-semibold mb-3">Ready to try {toolName}?</p>
        <a 
          href={affiliate_links.primary}
          target="_blank"
          rel="noopener noreferrer sponsored"
          class="affiliate-link inline-block px-8 py-3 bg-brand hover:bg-brand/80 text-white rounded-lg font-semibold transition-colors"
          data-affiliate="true"
          data-tool={toolName}
        >
          Get Started →
        </a>
        <p class="text-xs text-slate-500 mt-3">This is an affiliate link. We may earn a commission.</p>
      </div>
    )}
  </article>
  
  <!-- Track Review View -->
  <script define:vars={{ toolName, rating: rating.overall }}>
    // Track that user viewed this review
    if (typeof gtag !== 'undefined') {
      gtag('event', 'review_view', {
        tool_name: toolName,
        rating: rating,
      });
    }
  </script>
</BaseLayout>

<style>
  /* Better spacing control for review content */
  :global(article h2) {
    margin-top: 3rem !important;
    margin-bottom: 1.25rem !important;
  }
  
  :global(article h3) {
    margin-top: 2rem !important;
    margin-bottom: 1rem !important;
  }
  
  :global(article h4) {
    margin-top: 1.5rem !important;
    margin-bottom: 0.75rem !important;
  }
  
  :global(article p) {
    margin-bottom: 1.25rem !important;
  }
  
  /* Spacing around lists */
  :global(article ul),
  :global(article ol) {
    margin: 1.25rem 0 !important;
  }
  
  :global(article li) {
    margin: 0.5rem 0 !important;
  }
  
  /* Code blocks */
  :global(article pre) {
    margin: 1.25rem 0 !important;
  }
  
  /* Components spacing */
  :global(article > div) {
    margin: 1.5rem 0 !important;
  }
  
  /* Spacing between different elements */
  :global(article p + ul),
  :global(article p + ol),
  :global(article ul + p),
  :global(article ol + p),
  :global(article pre + p),
  :global(article p + pre) {
    margin-top: 1.25rem !important;
  }
  
  :global(article h2 + p),
  :global(article h3 + p),
  :global(article h4 + p) {
    margin-top: 0.5rem !important;
  }
</style>