---
import BaseLayout from '../layouts/BaseLayout.astro';
import Nav from '../components/Nav.astro';
import { getCollection } from 'astro:content';

// Get all reviews to show their pricing
const allReviews = await getCollection('reviews');

// Get current date for "Last updated"
const lastUpdated = new Date().toLocaleDateString('en-US', { 
  month: 'long', 
  day: 'numeric', 
  year: 'numeric' 
});
---

<BaseLayout 
  title="AI Tool Deals & Pricing Comparison" 
  description="Compare pricing across 20+ AI tools. Find the best deals on ChatGPT, Claude, Midjourney, and more."
>
  <Nav />
  
  <div class="max-w-5xl mx-auto">
    <header class="mb-12">
      <h1 class="text-4xl font-bold mb-4">AI Tool Deals & Pricing</h1>
      <p class="text-xl text-slate-400 mb-2">
        Live pricing comparison across {allReviews.length} AI tools
      </p>
      <p class="text-sm text-slate-500">Last updated: {lastUpdated}</p>
    </header>

    <!-- Quick Filter -->
    <div class="mb-8 flex gap-3 flex-wrap">
      <button onclick="filterDeals('all')" class="px-4 py-2 bg-brand/20 hover:bg-brand/30 rounded-lg text-sm font-semibold transition-colors">
        All Tools
      </button>
      <button onclick="filterDeals('free')" class="px-4 py-2 bg-slate-800 hover:bg-slate-700 rounded-lg text-sm transition-colors">
        Free Tier Available
      </button>
      <button onclick="filterDeals('paid')" class="px-4 py-2 bg-slate-800 hover:bg-slate-700 rounded-lg text-sm transition-colors">
        Paid Only
      </button>
    </div>

    <!-- Pricing Cards -->
    <div class="grid gap-6">
      {allReviews
        .sort((a, b) => {
          // Sort by price (free tier first, then by starting price)
          const aPrice = a.data.pricing?.startingPrice || 0;
          const bPrice = b.data.pricing?.startingPrice || 0;
          const aFree = a.data.pricing?.hasFree ? -1 : 0;
          const bFree = b.data.pricing?.hasFree ? -1 : 0;
          return aFree - bFree || aPrice - bPrice;
        })
        .map((review) => {
          const hasFree = review.data.pricing?.hasFree || false;
          const startingPrice = review.data.pricing?.startingPrice || 0;
          const priceCategory = hasFree ? 'free' : 'paid';
          
          return (
            <div class={`deal-card pricing-card bg-slate-900/40 border border-slate-800 rounded-xl p-6 hover:border-brand/50 transition-colors`} data-category={priceCategory}>
              <div class="flex justify-between items-start gap-4">
                <div class="flex-1">
                  <div class="flex items-center gap-3 mb-2">
                    <h3 class="text-xl font-bold">{review.data.title}</h3>
                    {hasFree && (
                      <span class="px-2 py-1 bg-green-600/20 text-green-400 text-xs font-semibold rounded">FREE TIER</span>
                    )}
                  </div>
                  
                  <p class="text-sm text-slate-400 mb-4">{review.data.description}</p>
                  
                  <div class="flex gap-6 text-sm mb-4">
                    <div>
                      <span class="text-slate-500">Free Plan:</span>
                      <span class="ml-2 font-semibold text-slate-200">
                        {hasFree ? '✓ Available' : '✗ No'}
                      </span>
                    </div>
                    <div>
                      <span class="text-slate-500">Starting at:</span>
                      <span class="ml-2 font-semibold text-brand">
                        {startingPrice > 0 ? `$${startingPrice}/mo` : 'Free'}
                      </span>
                    </div>
                    {review.data.rating && (
                      <div>
                        <span class="text-slate-500">Rating:</span>
                        <span class="ml-2 font-semibold text-yellow-500">
                          {review.data.rating.overall}/10
                        </span>
                      </div>
                    )}
                  </div>

                  <div class="flex gap-3">
                    <a 
                      href={`/reviews/${review.slug}`}
                      class="px-4 py-2 bg-slate-800 hover:bg-slate-700 rounded-lg text-sm font-semibold transition-colors"
                    >
                      Read Review
                    </a>
                    {review.data.affiliate_links?.primary && (
                      <a 
                        href={review.data.affiliate_links.primary}
                        target="_blank"
                        rel="noopener noreferrer sponsored"
                        class="affiliate-link px-4 py-2 bg-brand hover:bg-brand/80 rounded-lg text-sm font-semibold transition-colors"
                        data-affiliate="true"
                        data-tool={review.data.title}
                      >
                        Try {review.data.title} →
                      </a>
                    )}
                  </div>
                </div>
                
                <div class="text-right">
                  <div class="text-3xl font-bold text-brand">
                    {startingPrice > 0 ? `$${startingPrice}` : 'Free'}
                  </div>
                  <div class="text-xs text-slate-500">
                    {startingPrice > 0 ? 'per month' : 'to start'}
                  </div>
                  {review.data.rating && (
                    <div class="mt-3">
                      <div class="text-2xl font-bold text-yellow-500">{review.data.rating.overall}</div>
                      <div class="text-xs text-slate-500">/ 10</div>
                    </div>
                  )}
                </div>
              </div>
            </div>
          );
        })
      }
    </div>

    <!-- Price Comparison Table -->
    <section class="mt-16">
      <h2 class="text-2xl font-bold mb-6">Quick Price Comparison</h2>
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead class="bg-slate-800/50">
            <tr class="border-b border-slate-700">
              <th class="text-left py-3 px-4">Tool</th>
              <th class="text-left py-3 px-4">Category</th>
              <th class="text-left py-3 px-4">Free Tier</th>
              <th class="text-right py-3 px-4">Starting Price</th>
              <th class="text-center py-3 px-4">Rating</th>
            </tr>
          </thead>
          <tbody>
            {allReviews
              .sort((a, b) => (a.data.pricing?.startingPrice || 0) - (b.data.pricing?.startingPrice || 0))
              .map((review) => (
                <tr class={`border-b border-slate-800 hover:bg-slate-800/30 transition-colors`}>
                  <td class="py-3 px-4">
                    <a href={`/reviews/${review.slug}`} class="hover:text-brand transition-colors font-semibold">
                      {review.data.title}
                    </a>
                  </td>
                  <td class="py-3 px-4 text-slate-400">
                    {review.data.tags?.[0] || 'AI Tool'}
                  </td>
                  <td class="py-3 px-4">
                    {review.data.pricing?.hasFree ? (
                      <span class="text-green-400">✓</span>
                    ) : (
                      <span class="text-slate-600">—</span>
                    )}
                  </td>
                  <td class="py-3 px-4 text-right font-semibold">
                    {review.data.pricing?.startingPrice ? `$${review.data.pricing.startingPrice}/mo` : 'Free'}
                  </td>
                  <td class="py-3 px-4 text-center">
                    {review.data.rating ? (
                      <span class="text-yellow-500 font-semibold">{review.data.rating.overall}/10</span>
                    ) : (
                      <span class="text-slate-600">—</span>
                    )}
                  </td>
                </tr>
              ))
            }
          </tbody>
        </table>
      </div>
    </section>

    <!-- Disclosure -->
    <div class="mt-12 bg-slate-800/30 border border-slate-700 rounded-xl p-6 text-sm text-slate-400">
      <p class="mb-2">
        <strong class="text-slate-300">Note:</strong> Prices shown are starting prices and may vary. 
        Some tools offer multiple tiers with additional features at higher price points.
      </p>
      <p>
        We earn commissions from affiliate links at no additional cost to you. Prices are updated regularly but may change.
      </p>
    </div>
  </div>

  <script is:inline>
    function filterDeals(category) {
      const cards = document.querySelectorAll('.deal-card');
      const buttons = document.querySelectorAll('button[onclick^="filterDeals"]');
      
      // Update button styles
      buttons.forEach(btn => {
        btn.className = btn.onclick.toString().includes(`'${category}'`)
          ? 'px-4 py-2 bg-brand/20 hover:bg-brand/30 rounded-lg text-sm font-semibold transition-colors'
          : 'px-4 py-2 bg-slate-800 hover:bg-slate-700 rounded-lg text-sm transition-colors';
      });
      
      // Filter cards
      cards.forEach(card => {
        if (category === 'all') {
          card.style.display = 'block';
        } else {
          card.style.display = card.dataset.category === category ? 'block' : 'none';
        }
      });
    }
  </script>
</BaseLayout>
