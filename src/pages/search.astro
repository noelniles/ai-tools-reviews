---
import BaseLayout from '../layouts/BaseLayout.astro';
import Nav from '../components/Nav.astro';
import { getCollection } from 'astro:content';

const allReviews = await getCollection('reviews');
const allTechnical = await getCollection('technical');
const allContent = [...allReviews, ...allTechnical];
---

<BaseLayout 
  title="Search Reviews - Bench The Bots"
  description="Search for AI tool reviews and comparisons"
>
  <Nav />
  
  <div class="max-w-4xl mx-auto px-4">
    <header class="mb-12">
      <h1 class="text-4xl font-bold mb-4">Search</h1>
      <p class="text-xl text-slate-400">
        Find reviews, technical articles, and insights on AI tools
      </p>
    </header>

    <!-- Search Input -->
    <div class="mb-8">
      <div class="relative">
        <input 
          type="text" 
          id="search-input"
          placeholder="Search for an AI tool (e.g., ChatGPT, Midjourney, Claude)..." 
          class="w-full px-6 py-4 bg-slate-900 border border-slate-700 rounded-sm text-lg focus:outline-none focus:border-brand focus:ring-2 focus:ring-brand/50 transition-all"
          autocomplete="off"
        />
        <svg class="absolute right-4 top-1/2 -translate-y-1/2 w-6 h-6 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
        </svg>
      </div>
      <p class="text-sm text-slate-500 mt-2">
        <span id="result-count">{allReviews.length} reviews + {allTechnical.length} articles</span> available
      </p>
    </div>

    <!-- Search Results -->
    <div id="search-results" class="space-y-4">
      <!-- Reviews -->
      {allReviews.map((review) => (
        <a 
          href={`/reviews/${review.slug}`}
          class="content-card block bg-slate-900/40 border border-slate-800 rounded-sm p-6 hover:border-brand/50 transition-colors"
          data-type="review"
          data-title={review.data.title.toLowerCase()}
          data-description={review.data.description.toLowerCase()}
          data-tags={review.data.tags?.join(' ').toLowerCase() || ''}
        >
          <div class="flex items-start justify-between gap-4">
            <div class="flex-1">
              <div class="flex items-center gap-2 mb-2">
                <span class="text-xs px-2 py-0.5 bg-blue-500/20 text-blue-300 rounded font-semibold">REVIEW</span>
                <h3 class="font-bold text-xl text-slate-100">{review.data.title}</h3>
              </div>
              <p class="text-sm text-slate-400 mb-3">{review.data.description}</p>
              <div class="flex flex-wrap gap-2">
                {review.data.tags?.map((tag) => (
                  <span class="text-xs px-2 py-1 bg-slate-800 text-slate-300 rounded">
                    {tag}
                  </span>
                ))}
              </div>
            </div>
            <div class="flex flex-col items-end gap-2">
              <div class="flex items-center gap-1">
                <svg class="w-5 h-5 text-yellow-500" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                </svg>
                <span class="font-semibold text-slate-200">{review.data.rating.overall}/10</span>
              </div>
              <span class="text-xs text-slate-500">{new Date(review.data.date).toLocaleDateString()}</span>
            </div>
          </div>
        </a>
      ))}
      
      <!-- Technical Articles -->
      {allTechnical.map((article) => (
        <a 
          href={`/technical/${article.slug}`}
          class="content-card block bg-slate-900/40 border border-slate-800 rounded-sm p-6 hover:border-purple-500/50 transition-colors"
          data-type="technical"
          data-title={article.data.title.toLowerCase()}
          data-description={article.data.description.toLowerCase()}
          data-tags={article.data.tags?.join(' ').toLowerCase() || ''}
        >
          <div class="flex items-start gap-4">
            <div class="flex-1">
              <div class="flex items-center gap-2 mb-2">
                <span class="text-xs px-2 py-0.5 bg-purple-500/20 text-purple-300 rounded font-semibold">TECHNICAL</span>
                <h3 class="font-bold text-xl text-slate-100">{article.data.title}</h3>
              </div>
              <p class="text-sm text-slate-400 mb-3">{article.data.description}</p>
              <div class="flex flex-wrap gap-2">
                {article.data.tags?.map((tag) => (
                  <span class="text-xs px-2 py-1 bg-slate-800 text-slate-300 rounded">
                    {tag}
                  </span>
                ))}
              </div>
            </div>
            <div class="flex flex-col items-end gap-2">
              <span class="text-xs text-slate-500">{new Date(article.data.date).toLocaleDateString()}</span>
            </div>
          </div>
        </a>
      ))}
    </div>

    <!-- No Results / Suggestion Form -->
    <div id="no-results" class="hidden">
      <div class="bg-gradient-to-br from-slate-900 to-slate-800 border border-slate-700 rounded-sm p-8 text-center">
        <svg class="w-16 h-16 text-slate-600 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        <h3 class="text-2xl font-bold text-slate-200 mb-2">No reviews found</h3>
        <p class="text-slate-400 mb-6">
          We haven't reviewed "<span id="search-term-display" class="text-brand font-semibold"></span>" yet.
        </p>
        
        <div class="bg-gradient-to-r from-brand/10 to-purple-500/10 border border-brand/20 rounded-sm p-6 mb-6">
          <h4 class="font-semibold text-lg text-slate-100 mb-2">Request this review</h4>
          <p class="text-sm text-slate-400 mb-4">
            Let us know you want a review of this tool. We prioritize based on community requests.
          </p>
          
          <form 
            id="suggestion-form" 
            action={import.meta.env.PUBLIC_FORMSPREE_SUGGESTIONS_ID ? `https://formspree.io/f/${import.meta.env.PUBLIC_FORMSPREE_SUGGESTIONS_ID}` : 'https://formspree.io/f/YOUR_FORM_ID'}
            method="POST"
            class="space-y-4"
          >
            <input 
              type="hidden" 
              id="suggested-tool" 
              name="tool"
            />
            <input 
              type="hidden" 
              name="_subject" 
              value="New AI Tool Review Request"
            />
            <div>
              <input 
                type="email" 
                name="email"
                placeholder="Your email (optional)" 
                class="w-full px-4 py-2 bg-slate-900 border border-slate-700 rounded-sm text-sm focus:outline-none focus:border-brand focus:ring-1 focus:ring-brand"
              />
            </div>
            <div>
              <textarea 
                name="notes"
                placeholder="Any specific features or comparisons you'd like to see? (optional)" 
                rows="3"
                class="w-full px-4 py-2 bg-slate-900 border border-slate-700 rounded-sm text-sm focus:outline-none focus:border-brand focus:ring-1 focus:ring-brand resize-none"
              ></textarea>
            </div>
            <button 
              type="submit"
              class="w-full px-6 py-3 bg-brand hover:bg-brand/80 rounded-sm font-semibold transition-colors"
            >
              Request Review
            </button>
          </form>
        </div>

        <div class="text-sm text-slate-500">
          Or browse our <a href="/reviews" class="text-brand hover:underline">all reviews</a> to find something similar
        </div>
      </div>
    </div>
  </div>
</BaseLayout>

<script>
  const searchInput = document.getElementById('search-input') as HTMLInputElement;
  const searchResults = document.getElementById('search-results');
  const noResults = document.getElementById('no-results');
  const resultCount = document.getElementById('result-count');
  const contentCards = document.querySelectorAll('.content-card');
  const searchTermDisplay = document.getElementById('search-term-display');
  const suggestedToolInput = document.getElementById('suggested-tool') as HTMLInputElement;
  const suggestionForm = document.getElementById('suggestion-form');

  function performSearch(query: string) {
    const lowerQuery = query.toLowerCase().trim();
    
    if (!lowerQuery) {
      // Show all content
      contentCards.forEach(card => {
        (card as HTMLElement).classList.remove('hidden');
      });
      searchResults?.classList.remove('hidden');
      noResults?.classList.add('hidden');
      resultCount!.textContent = `${contentCards.length} items`;
      return;
    }

    let visibleCount = 0;
    
    contentCards.forEach(card => {
      const element = card as HTMLElement;
      const title = element.dataset.title || '';
      const description = element.dataset.description || '';
      const tags = element.dataset.tags || '';
      
      const matches = title.includes(lowerQuery) || 
                     description.includes(lowerQuery) || 
                     tags.includes(lowerQuery);
      
      if (matches) {
        element.classList.remove('hidden');
        visibleCount++;
      } else {
        element.classList.add('hidden');
      }
    });

    // Update UI based on results
    if (visibleCount === 0) {
      searchResults?.classList.add('hidden');
      noResults?.classList.remove('hidden');
      searchTermDisplay!.textContent = query;
      suggestedToolInput.value = query;
    } else {
      searchResults?.classList.remove('hidden');
      noResults?.classList.add('hidden');
      resultCount!.textContent = `${visibleCount} ${visibleCount === 1 ? 'result' : 'results'}`;
    }
  }

  // Search as you type
  searchInput?.addEventListener('input', (e) => {
    const query = (e.target as HTMLInputElement).value;
    performSearch(query);
  });

  // Handle suggestion form submission
  suggestionForm?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target as HTMLFormElement);
    const tool = formData.get('tool');
    const email = formData.get('email');
    const notes = formData.get('notes');
    
    // Track the suggestion
    if (typeof gtag !== 'undefined') {
      gtag('event', 'review_suggestion', {
        tool_name: tool,
        has_email: !!email,
        has_notes: !!notes
      });
    }
    
    // Show success message
    const form = e.target as HTMLElement;
    form.innerHTML = `
      <div class="text-center py-4">
        <svg class="w-12 h-12 text-green-500 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
        </svg>
        <p class="text-lg font-semibold text-green-400 mb-2">Request Submitted!</p>
        <p class="text-sm text-slate-400">We'll prioritize reviewing ${tool} based on community interest.</p>
      </div>
    `;
  });

  // Focus search input on load
  searchInput?.focus();
</script>

<style>
  .review-card {
    transition: all 0.2s ease;
  }
  
  .review-card:hover {
    transform: translateY(-2px);
  }
</style>
