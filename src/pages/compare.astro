---
import BaseLayout from '../layouts/BaseLayout.astro';
import Nav from '../components/Nav.astro';
import Icon from '../components/Icon.astro';
import { getCollection } from 'astro:content';

const reviews = await getCollection('reviews');
const sortedReviews = reviews.sort((a, b) => b.data.rating.overall - a.data.rating.overall);

// Prepare data for charts
const reviewsData = sortedReviews.map(r => ({
  slug: r.slug,
  title: r.data.title.replace(' Review', ''),
  rating: r.data.rating,
  tags: r.data.tags || [],
  pricing: r.data.pricing
}));
---

<BaseLayout 
  title="AI Tool Comparison & Finder" 
  description="Interactive comparison tool to help you find the perfect AI tool for your needs"
>
  <Nav />
  
  <div class="max-w-6xl mx-auto">
    <header class="mb-12 text-center">
      <h1 class="text-5xl font-bold mb-4">Find Your Perfect AI Tool</h1>
      <p class="text-xl text-slate-400 max-w-2xl mx-auto">Answer a few questions to discover which AI tool best fits your needs</p>
    </header>

    <!-- Decision Tree / Choose Your Own Adventure -->
    <section class="mb-16">
      <div class="bg-gradient-to-br from-slate-900 to-slate-800 rounded-2xl p-8 border border-slate-700">
        <h2 class="text-3xl font-bold mb-4 text-center">What do you want to create?</h2>
        <p class="text-center text-slate-400 mb-8">Select one or more categories to compare tools</p>
        
        <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6">
          <!-- Text/Writing Category -->
          <label class="category-checkbox cursor-pointer group">
            <input type="checkbox" value="text" class="category-input hidden" onchange="toggleCategory('text')">
            <div class="bg-slate-800/50 border-2 border-slate-700 rounded-sm p-6 text-left transition-all group-hover:border-brand">
              <div class="flex items-start justify-between mb-4">
                <Icon name="file-text" size="xl" class="text-brand" />
                <div class="checkbox-indicator w-6 h-6 border-2 border-slate-600 rounded flex items-center justify-center">
                  <Icon name="check" size="xs" class="text-brand hidden check-icon" />
                </div>
              </div>
              <h3 class="text-xl font-bold mb-2 group-hover:text-brand transition-colors">Text & Writing</h3>
              <p class="text-sm text-slate-400">Articles, marketing copy, documentation, chat</p>
            </div>
          </label>

          <!-- Code Category -->
          <label class="category-checkbox cursor-pointer group">
            <input type="checkbox" value="code" class="category-input hidden" onchange="toggleCategory('code')">
            <div class="bg-slate-800/50 border-2 border-slate-700 rounded-sm p-6 text-left transition-all group-hover:border-purple-500">
              <div class="flex items-start justify-between mb-4">
                <Icon name="terminal" size="xl" class="text-purple-400" />
                <div class="checkbox-indicator w-6 h-6 border-2 border-slate-600 rounded flex items-center justify-center">
                  <Icon name="check" size="xs" class="text-purple-400 hidden check-icon" />
                </div>
              </div>
              <h3 class="text-xl font-bold mb-2 group-hover:text-purple-400 transition-colors">Code & Development</h3>
              <p class="text-sm text-slate-400">Code completion, debugging, API tools</p>
            </div>
          </label>

          <!-- Image Category -->
          <label class="category-checkbox cursor-pointer group">
            <input type="checkbox" value="image" class="category-input hidden" onchange="toggleCategory('image')">
            <div class="bg-slate-800/50 border-2 border-slate-700 rounded-sm p-6 text-left transition-all group-hover:border-pink-500">
              <div class="flex items-start justify-between mb-4">
                <Icon name="beaker" size="xl" class="text-pink-400" />
                <div class="checkbox-indicator w-6 h-6 border-2 border-slate-600 rounded flex items-center justify-center">
                  <Icon name="check" size="xs" class="text-pink-400 hidden check-icon" />
                </div>
              </div>
              <h3 class="text-xl font-bold mb-2 group-hover:text-pink-400 transition-colors">Images & Art</h3>
              <p class="text-sm text-slate-400">AI art, image generation, photo editing</p>
            </div>
          </label>

          <!-- Video Category -->
          <label class="category-checkbox cursor-pointer group">
            <input type="checkbox" value="video" class="category-input hidden" onchange="toggleCategory('video')">
            <div class="bg-slate-800/50 border-2 border-slate-700 rounded-sm p-6 text-left transition-all group-hover:border-orange-500">
              <div class="flex items-start justify-between mb-4">
                <Icon name="video" size="xl" class="text-orange-400" />
                <div class="checkbox-indicator w-6 h-6 border-2 border-slate-600 rounded flex items-center justify-center">
                  <Icon name="check" size="xs" class="text-orange-400 hidden check-icon" />
                </div>
              </div>
              <h3 class="text-xl font-bold mb-2 group-hover:text-orange-400 transition-colors">Video & Animation</h3>
              <p class="text-sm text-slate-400">Video generation, editing, effects</p>
            </div>
          </label>
        </div>

        <!-- Budget Filter -->
        <div class="mt-8 pt-8 border-t border-slate-700">
          <h3 class="text-lg font-semibold mb-4 text-center">What's your budget?</h3>
          <div class="flex flex-wrap gap-4 justify-center">
            <button onclick="filterBudget('free')" class="budget-btn px-6 py-3 rounded-sm border-2 border-slate-700 hover:border-green-500 hover:bg-green-500/10 transition-all flex items-center gap-2">
              <Icon name="check-circle" size="sm" class="text-green-400" />
              Free Tier
            </button>
            <button onclick="filterBudget('budget')" class="budget-btn px-6 py-3 rounded-sm border-2 border-slate-700 hover:border-blue-500 hover:bg-blue-500/10 transition-all flex items-center gap-2">
              <Icon name="trending-up" size="sm" class="text-blue-400" />
              Budget ($0-20/mo)
            </button>
            <button onclick="filterBudget('pro')" class="budget-btn px-6 py-3 rounded-sm border-2 border-slate-700 hover:border-purple-500 hover:bg-purple-500/10 transition-all flex items-center gap-2">
              <Icon name="star" size="sm" class="text-purple-400" />
              Pro ($20-100/mo)
            </button>
            <button onclick="filterBudget('enterprise')" class="budget-btn px-6 py-3 rounded-sm border-2 border-slate-700 hover:border-orange-500 hover:bg-orange-500/10 transition-all flex items-center gap-2">
              <Icon name="lightning" size="sm" class="text-orange-400" />
              Enterprise ($100+/mo)
            </button>
          </div>
        </div>

        <!-- Reset Button -->
        <div class="text-center mt-6">
          <button onclick="resetFilters()" class="text-sm text-slate-400 hover:text-brand transition-colors underline">
            Reset Filters
          </button>
        </div>
      </div>
    </section>

    <!-- Radar Chart Comparison -->
    <section id="chart-section" class="mb-16 hidden">
      <div class="bg-gradient-to-br from-slate-900 to-slate-800 rounded-2xl p-8 border border-slate-700">
        <h2 class="text-3xl font-bold mb-4 text-center">Visual Comparison</h2>
        <p class="text-center text-slate-400 mb-8">Top tools in selected categories compared across key metrics</p>
        
        <div class="max-w-4xl mx-auto">
          <canvas id="comparison-chart" class="w-full" style="max-height: 500px;"></canvas>
        </div>
        
        <div class="mt-6 text-center text-sm text-slate-400">
          <p>Scores based on overall rating, usability, quality, and pricing</p>
        </div>
      </div>
    </section>

    <!-- Comparison Table -->
    <section class="mb-16">
      <h2 class="text-3xl font-bold mb-8">Quick Comparison Table</h2>
      
      <div class="overflow-x-auto bg-slate-900/40 border border-slate-800 rounded-sm">
        <table class="w-full">
          <thead>
            <tr class="border-b border-slate-800">
              <th class="text-left p-4 font-semibold text-slate-300 sticky left-0 bg-slate-900">Tool</th>
              <th class="text-center p-4 font-semibold text-slate-300">Rating</th>
              <th class="text-left p-4 font-semibold text-slate-300">Best For</th>
              <th class="text-left p-4 font-semibold text-slate-300">Free Tier</th>
              <th class="text-right p-4 font-semibold text-slate-300">From</th>
              <th class="text-center p-4 font-semibold text-slate-300"></th>
            </tr>
          </thead>
          <tbody>
            {sortedReviews.map((review) => (
              <tr class="border-b border-slate-800 hover:bg-slate-800/30 transition-colors tool-row" 
                  data-category={review.data.tags?.[0]?.toLowerCase() || 'other'}
                  data-price={review.data.pricing?.startingPrice || 0}>
                <td class="p-4 font-semibold text-slate-100 sticky left-0 bg-slate-900/95">
                  <a href={`/reviews/${review.slug}`} class="hover:text-brand transition-colors">
                    {review.data.title.replace(' Review', '')}
                  </a>
                </td>
                <td class="p-4 text-center">
                  <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-brand/20 border border-brand/30">
                    <Icon name="star" size="xs" class="text-yellow-400" />
                    <span class="font-bold text-brand">{review.data.rating.overall}/10</span>
                  </div>
                </td>
                <td class="p-4 text-slate-400 text-sm">
                  {review.data.tags?.slice(0, 2).join(', ') || 'AI Tool'}
                </td>
                <td class="p-4 text-slate-400 text-sm">
                  <div class="flex items-center gap-1.5">
                    {review.data.pricing?.hasFree ? (
                      <><Icon name="check" size="xs" class="text-green-400" /> <span>Yes</span></>
                    ) : (
                      <><Icon name="x" size="xs" class="text-red-400" /> <span>No</span></>
                    )}
                  </div>
                </td>
                <td class="p-4 text-right text-slate-300 font-semibold">
                  {review.data.pricing?.startingPrice 
                    ? `$${review.data.pricing.startingPrice}/mo`
                    : 'Free'}
                </td>
                <td class="p-4 text-center">
                  <a 
                    href={`/reviews/${review.slug}`}
                    class="inline-block px-4 py-2 bg-slate-800 hover:bg-brand text-sm rounded-sm transition-colors"
                  >
                    Review â†’
                  </a>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </section>

    <!-- Top Picks by Category -->
    <section class="mb-16">
      <h2 class="text-3xl font-bold mb-8">Top Picks by Category</h2>
      
      <div class="grid md:grid-cols-2 gap-6">
        <!-- Best for Writing -->
        <div class="bg-gradient-to-br from-blue-500/10 to-transparent border border-blue-500/30 rounded-sm p-6">
          <div class="flex items-center gap-3 mb-4">
            <Icon name="file-text" size="lg" class="text-brand" />
            <h3 class="text-xl font-bold">Best for Writing</h3>
          </div>
          <p class="text-slate-400 text-sm mb-4">Top AI writing assistants for content creation</p>
          <div class="space-y-2">
            {sortedReviews.filter(r => r.data.tags?.some(t => ['writing', 'text', 'content'].includes(t.toLowerCase()))).slice(0, 3).map(r => (
              <a href={`/reviews/${r.slug}`} class="block p-3 bg-slate-900/40 rounded-sm hover:bg-slate-800/60 transition-colors">
                <div class="flex items-center justify-between">
                  <span class="font-semibold">{r.data.title.replace(' Review', '')}</span>
                  <span class="text-sm text-brand">{r.data.rating.overall}/10</span>
                </div>
              </a>
            ))}
          </div>
        </div>

        <!-- Best for Code -->
        <div class="bg-gradient-to-br from-purple-500/10 to-transparent border border-purple-500/30 rounded-sm p-6">
          <div class="flex items-center gap-3 mb-4">
            <Icon name="terminal" size="lg" class="text-purple-400" />
            <h3 class="text-xl font-bold">Best for Coding</h3>
          </div>
          <p class="text-slate-400 text-sm mb-4">Top AI coding assistants and development tools</p>
          <div class="space-y-2">
            {sortedReviews.filter(r => r.data.tags?.some(t => ['code', 'development', 'programming'].includes(t.toLowerCase()))).slice(0, 3).map(r => (
              <a href={`/reviews/${r.slug}`} class="block p-3 bg-slate-900/40 rounded-sm hover:bg-slate-800/60 transition-colors">
                <div class="flex items-center justify-between">
                  <span class="font-semibold">{r.data.title.replace(' Review', '')}</span>
                  <span class="text-sm text-brand">{r.data.rating.overall}/10</span>
                </div>
              </a>
            ))}
          </div>
        </div>

        <!-- Best for Images -->
        <div class="bg-gradient-to-br from-pink-500/10 to-transparent border border-pink-500/30 rounded-sm p-6">
          <div class="flex items-center gap-3 mb-4">
            <Icon name="beaker" size="lg" class="text-pink-400" />
            <h3 class="text-xl font-bold">Best for Images</h3>
          </div>
          <p class="text-slate-400 text-sm mb-4">Top AI image generators and art tools</p>
          <div class="space-y-2">
            {sortedReviews.filter(r => r.data.tags?.some(t => ['image', 'art', 'design'].includes(t.toLowerCase()))).slice(0, 3).map(r => (
              <a href={`/reviews/${r.slug}`} class="block p-3 bg-slate-900/40 rounded-sm hover:bg-slate-800/60 transition-colors">
                <div class="flex items-center justify-between">
                  <span class="font-semibold">{r.data.title.replace(' Review', '')}</span>
                  <span class="text-sm text-brand">{r.data.rating.overall}/10</span>
                </div>
              </a>
            ))}
          </div>
        </div>

        <!-- Best for Video -->
        <div class="bg-gradient-to-br from-orange-500/10 to-transparent border border-orange-500/30 rounded-sm p-6">
          <div class="flex items-center gap-3 mb-4">
            <Icon name="video" size="lg" class="text-orange-400" />
            <h3 class="text-xl font-bold">Best for Video</h3>
          </div>
          <p class="text-slate-400 text-sm mb-4">Top AI video generation and editing tools</p>
          <div class="space-y-2">
            {sortedReviews.filter(r => r.data.tags?.some(t => ['video', 'animation'].includes(t.toLowerCase()))).slice(0, 3).map(r => (
              <a href={`/reviews/${r.slug}`} class="block p-3 bg-slate-900/40 rounded-sm hover:bg-slate-800/60 transition-colors">
                <div class="flex items-center justify-between">
                  <span class="font-semibold">{r.data.title.replace(' Review', '')}</span>
                  <span class="text-sm text-brand">{r.data.rating.overall}/10</span>
                </div>
              </a>
            ))}
          </div>
        </div>
      </div>
    </section>
  </div>
</BaseLayout>

<script type="application/json" id="reviews-data" set:html={JSON.stringify(reviewsData)} />

<script is:inline>
  let selectedCategories = new Set();
  let currentBudget = 'all';
  let comparisonChart = null;

  // Reviews data from Astro
  const reviewsData = JSON.parse(document.getElementById('reviews-data').textContent);

  function toggleCategory(category) {
    if (selectedCategories.has(category)) {
      selectedCategories.delete(category);
    } else {
      selectedCategories.add(category);
    }
    
    // Update UI
    updateCategoryUI(category);
    applyFilters();
    updateChart();
  }

  function updateCategoryUI(category) {
    const checkbox = document.querySelector(`input[value="${category}"]`);
    const label = checkbox.closest('.category-checkbox');
    const checkIcon = label.querySelector('.check-icon');
    const box = label.querySelector('.checkbox-indicator');
    
    if (selectedCategories.has(category)) {
      checkIcon.classList.remove('hidden');
      box.classList.add('bg-brand/20', 'border-brand');
      label.querySelector('div > div').classList.add('border-brand', 'bg-brand/10');
    } else {
      checkIcon.classList.add('hidden');
      box.classList.remove('bg-brand/20', 'border-brand');
      label.querySelector('div > div').classList.remove('border-brand', 'bg-brand/10');
    }
  }

  function filterBudget(budget) {
    currentBudget = budget;
    applyFilters();
    
    // Update budget button styles
    document.querySelectorAll('.budget-btn').forEach(btn => {
      btn.classList.remove('border-brand', 'bg-brand/20');
    });
    event.target.closest('.budget-btn').classList.add('border-brand', 'bg-brand/20');
  }

  function resetFilters() {
    selectedCategories.clear();
    currentBudget = 'all';
    
    // Reset UI
    document.querySelectorAll('.category-input').forEach(input => {
      input.checked = false;
      updateCategoryUI(input.value);
    });
    
    document.querySelectorAll('.budget-btn').forEach(btn => {
      btn.classList.remove('border-brand', 'bg-brand/20');
    });
    
    applyFilters();
    updateChart();
  }

  function applyFilters() {
    const rows = document.querySelectorAll('.tool-row');
    
    rows.forEach(row => {
      const rowCategory = row.getAttribute('data-category');
      const rowPrice = parseFloat(row.getAttribute('data-price') || '0');
      
      // Map tags to categories
      const categoryMap = {
        'ai': 'text', 'llm': 'text', 'chatbot': 'text',
        'content writing': 'text', 'writing': 'text', 'marketing': 'text',
        'code': 'code', 'coding': 'code', 'programming': 'code', 'development': 'code',
        'image': 'image', 'art': 'image', 'photo': 'image', 'design': 'image',
        'video': 'video', 'animation': 'video',
        'voice': 'text', 'audio': 'text', 'transcription': 'text'
      };
      
      const mappedCategory = categoryMap[rowCategory] || rowCategory;
      let categoryMatch = selectedCategories.size === 0 || selectedCategories.has(mappedCategory);
      
      let budgetMatch = true;
      if (currentBudget === 'free') budgetMatch = rowPrice === 0;
      else if (currentBudget === 'budget') budgetMatch = rowPrice > 0 && rowPrice <= 20;
      else if (currentBudget === 'pro') budgetMatch = rowPrice > 20 && rowPrice <= 100;
      else if (currentBudget === 'enterprise') budgetMatch = rowPrice > 100;
      
      if (categoryMatch && budgetMatch) {
        row.style.display = '';
      } else {
        row.style.display = 'none';
      }
    });
  }

  function updateChart() {
    if (selectedCategories.size === 0) {
      document.getElementById('chart-section').classList.add('hidden');
      return;
    }
    
    document.getElementById('chart-section').classList.remove('hidden');
    
    // Wait for Chart.js to be loaded
    if (typeof Chart === 'undefined') {
      setTimeout(updateChart, 100);
      return;
    }
    
    // Get top tools for selected categories
    const categoryMap = {
      'ai': 'text', 'llm': 'text', 'chatbot': 'text',
      'content writing': 'text', 'writing': 'text', 'marketing': 'text',
      'code': 'code', 'coding': 'code', 'programming': 'code', 'development': 'code',
      'image': 'image', 'art': 'image', 'photo': 'image', 'design': 'image',
      'video': 'video', 'animation': 'video'
    };
    
    const filteredTools = reviewsData.filter(tool => {
      const toolCategories = tool.tags.map(tag => categoryMap[tag.toLowerCase()] || tag.toLowerCase());
      return Array.from(selectedCategories).some(cat => toolCategories.includes(cat));
    }).sort((a, b) => b.rating.overall - a.rating.overall).slice(0, 5);
    
    if (filteredTools.length === 0) {
      document.getElementById('chart-section').classList.add('hidden');
      return;
    }
    
    const canvas = document.getElementById('comparison-chart');
    const ctx = canvas.getContext('2d');
    
    // Destroy existing chart
    if (comparisonChart) {
      comparisonChart.destroy();
    }
    
    const datasets = filteredTools.map((tool, idx) => {
      const colors = [
        { bg: 'rgba(14, 165, 233, 0.2)', border: 'rgb(14, 165, 233)' },
        { bg: 'rgba(168, 85, 247, 0.2)', border: 'rgb(168, 85, 247)' },
        { bg: 'rgba(236, 72, 153, 0.2)', border: 'rgb(236, 72, 153)' },
        { bg: 'rgba(34, 197, 94, 0.2)', border: 'rgb(34, 197, 94)' },
        { bg: 'rgba(251, 146, 60, 0.2)', border: 'rgb(251, 146, 60)' }
      ];
      
      return {
        label: tool.title,
        data: [
          tool.rating.overall || 0,
          tool.rating.usability || tool.rating.overall || 0,
          tool.rating.quality || tool.rating.overall || 0,
          tool.rating.pricing || tool.rating.overall || 0,
          (tool.pricing && tool.pricing.hasFree ? 10 : tool.pricing && tool.pricing.startingPrice <= 20 ? 7 : 5)
        ],
        backgroundColor: colors[idx % 5].bg,
        borderColor: colors[idx % 5].border,
        borderWidth: 2
      };
    });
    
    comparisonChart = new Chart(ctx, {
      type: 'radar',
      data: {
        labels: ['Overall Rating', 'Usability', 'Quality', 'Pricing Value', 'Affordability'],
        datasets: datasets
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: {
            labels: {
              color: 'rgb(203, 213, 225)',
              font: { size: 14 }
            }
          }
        },
        scales: {
          r: {
            beginAtZero: true,
            max: 10,
            ticks: {
              color: 'rgb(148, 163, 184)',
              backdropColor: 'transparent',
              stepSize: 2
            },
            grid: { color: 'rgba(148, 163, 184, 0.2)' },
            pointLabels: { 
              color: 'rgb(203, 213, 225)',
              font: { size: 12 }
            }
          }
        }
      }
    });
  }
  
  // Load Chart.js immediately
  (function loadChartJS() {
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
    script.async = true;
    document.head.appendChild(script);
  })();
</script>

<style>
  .category-checkbox:hover > div,
  .budget-btn:hover {
    transform: translateY(-2px);
  }
  
  .sticky {
    position: sticky;
  }
  
  .category-checkbox input:checked + div {
    border-color: var(--brand-color);
    background-color: rgba(14, 165, 233, 0.1);
  }
</style>
</BaseLayout>
