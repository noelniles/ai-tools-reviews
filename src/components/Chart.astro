---
interface Props {
  data: {
    labels: string[]
    datasets: {
      label: string
      data: number[]
      backgroundColor?: string | string[]
      borderColor?: string | string[]
      borderWidth?: number
    }[]
  }
  type?: 'bar' | 'radar' | 'line' | 'doughnut'
  title?: string
  height?: number
}

const { data, type = 'bar', title, height = 300 } = Astro.props
const chartId = `chart-${Math.random().toString(36).substr(2, 9)}`
const chartData = JSON.stringify(data)
const chartType = type
---

<div class="chart-container my-8">
  {title && <h3 class="text-lg font-semibold mb-4 text-slate-200">{title}</h3>}
  <div class="bg-slate-900/40 border border-slate-800 rounded-xl p-6">
    <canvas id={chartId} data-chart-type={chartType} data-chart-data={chartData} style={`max-height: ${height}px`}></canvas>
  </div>
</div>

<script>
  import { Chart, registerables } from 'chart.js'
  Chart.register(...registerables)

  const defaultColors = {
    brand: 'rgb(14, 165, 233)',
    brandAlpha: 'rgba(14, 165, 233, 0.5)',
    purple: 'rgb(168, 85, 247)',
    purpleAlpha: 'rgba(168, 85, 247, 0.5)',
    green: 'rgb(34, 197, 94)',
    greenAlpha: 'rgba(34, 197, 94, 0.5)',
    red: 'rgb(239, 68, 68)',
    redAlpha: 'rgba(239, 68, 68, 0.5)',
    yellow: 'rgb(234, 179, 8)',
    yellowAlpha: 'rgba(234, 179, 8, 0.5)',
  }

  // Wait for window load to ensure all styles are loaded
  function initCharts() {
    const canvases = document.querySelectorAll('canvas[data-chart-type]')
    
    canvases.forEach((canvas) => {
      const chartType = canvas.getAttribute('data-chart-type')
      const chartDataStr = canvas.getAttribute('data-chart-data')
      
      if (!chartDataStr) return
      
      const data = JSON.parse(chartDataStr)
      
      // Apply default colors if not specified
      const chartData = {
        ...data,
        datasets: data.datasets.map((dataset, idx) => ({
          ...dataset,
          backgroundColor: dataset.backgroundColor || [
            defaultColors.brandAlpha,
            defaultColors.purpleAlpha,
            defaultColors.greenAlpha,
            defaultColors.redAlpha,
            defaultColors.yellowAlpha
          ][idx % 5],
          borderColor: dataset.borderColor || [
            defaultColors.brand,
            defaultColors.purple,
            defaultColors.green,
            defaultColors.red,
            defaultColors.yellow
          ][idx % 5],
          borderWidth: dataset.borderWidth || 2
        }))
      }

      new Chart(canvas, {
        type: chartType,
        data: chartData,
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              labels: {
                color: 'rgb(203, 213, 225)',
                font: { size: 12 }
              }
            }
          },
          scales: chartType !== 'doughnut' && chartType !== 'radar' ? {
            y: {
              beginAtZero: true,
              ticks: { color: 'rgb(148, 163, 184)' },
              grid: { color: 'rgba(148, 163, 184, 0.1)' }
            },
            x: {
              ticks: { color: 'rgb(148, 163, 184)' },
              grid: { color: 'rgba(148, 163, 184, 0.1)' }
            }
          } : chartType === 'radar' ? {
            r: {
              beginAtZero: true,
              max: 10,
              ticks: { 
                color: 'rgb(148, 163, 184)',
                backdropColor: 'transparent'
              },
              grid: { color: 'rgba(148, 163, 184, 0.2)' },
              pointLabels: { color: 'rgb(203, 213, 225)' }
            }
          } : undefined
        }
      })
    })
  }
  
  // Initialize on window load instead of DOMContentLoaded
  if (document.readyState === 'complete') {
    initCharts();
  } else {
    window.addEventListener('load', initCharts);
  }
</script>
