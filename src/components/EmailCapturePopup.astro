---
interface Props {
  delay?: number;
  exitIntent?: boolean;
}

const { delay = 15000, exitIntent = true } = Astro.props;
const formspreeId = import.meta.env.PUBLIC_FORMSPREE_NEWSLETTER_ID || 'YOUR_FORM_ID';
---

<div id="email-popup" class="email-popup fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
  <div class="popup-content bg-slate-900 border-2 border-brand/30 rounded-2xl p-8 max-w-md w-full relative animate-slide-up shadow-2xl">
    <button id="close-popup" class="absolute top-4 right-4 text-slate-400 hover:text-white transition-colors">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
      </svg>
    </button>
    
    <div class="text-center mb-6">
      <div class="w-16 h-16 bg-gradient-to-br from-brand to-purple-500 rounded-full mx-auto mb-4 flex items-center justify-center">
        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
        </svg>
      </div>
      <h3 class="text-2xl font-bold text-white mb-2">ðŸš€ Get AI Tool Insights</h3>
      <p class="text-slate-300 text-sm">
        Join 10,000+ readers getting weekly reviews, comparisons, and exclusive deals delivered to your inbox.
      </p>
    </div>
    
    <form id="popup-newsletter-form" action={`https://formspree.io/f/${formspreeId}`} method="POST" class="space-y-4">
      <div>
        <input
          type="email"
          name="email"
          placeholder="Enter your email"
          required
          class="w-full px-4 py-3 bg-slate-800 border border-slate-700 rounded-sm focus:outline-none focus:border-brand text-white placeholder-slate-400"
        />
      </div>
      
      <button
        type="submit"
        class="w-full px-6 py-3 bg-gradient-to-r from-brand to-purple-500 hover:from-brand/90 hover:to-purple-500/90 text-white font-semibold rounded-sm transition-all transform hover:scale-105"
      >
        Get Free Weekly Insights â†’
      </button>
      
      <p class="text-xs text-slate-500 text-center">
        âœ“ No spam, ever. Unsubscribe anytime.
      </p>
    </form>
    
    <div id="popup-success" class="hidden text-center">
      <div class="text-5xl mb-4">ðŸŽ‰</div>
      <h4 class="text-xl font-bold text-white mb-2">You're In!</h4>
      <p class="text-slate-300 text-sm">Check your email for confirmation.</p>
    </div>
  </div>
</div>

<style>
  @keyframes slide-up {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  .animate-slide-up {
    animation: slide-up 0.3s ease-out;
  }
  
  .email-popup.show {
    display: flex !important;
  }
</style>

<script define:vars={{ delay, exitIntent }}>
  const POPUP_STORAGE_KEY = 'email-popup-shown';
  const POPUP_COOLDOWN = 7 * 24 * 60 * 60 * 1000; // 7 days
  
  function shouldShowPopup() {
    const lastShown = localStorage.getItem(POPUP_STORAGE_KEY);
    if (!lastShown) return true;
    
    const timeSinceLastShown = Date.now() - parseInt(lastShown);
    return timeSinceLastShown > POPUP_COOLDOWN;
  }
  
  function showPopup() {
    if (!shouldShowPopup()) return;
    
    const popup = document.getElementById('email-popup');
    if (popup) {
      popup.classList.add('show');
      localStorage.setItem(POPUP_STORAGE_KEY, Date.now().toString());
      
      if (typeof gtag !== 'undefined') {
        gtag('event', 'popup_shown', {
          popup_type: 'email_capture',
          event_category: 'engagement',
        });
      }
    }
  }
  
  function closePopup() {
    const popup = document.getElementById('email-popup');
    if (popup) {
      popup.classList.remove('show');
    }
  }
  
  // Delay trigger
  setTimeout(showPopup, delay);
  
  // Exit intent trigger
  if (exitIntent) {
    let exitIntentFired = false;
    document.addEventListener('mouseleave', (e) => {
      if (e.clientY < 0 && !exitIntentFired) {
        exitIntentFired = true;
        showPopup();
      }
    });
  }
  
  // Close button
  document.getElementById('close-popup')?.addEventListener('click', closePopup);
  
  // Click outside to close
  document.getElementById('email-popup')?.addEventListener('click', (e) => {
    if (e.target === e.currentTarget) {
      closePopup();
    }
  });
  
  // Form submission
  const form = document.getElementById('popup-newsletter-form');
  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(form as HTMLFormElement);
    const email = formData.get('email');
    
    try {
      const response = await fetch((form as HTMLFormElement).action, {
        method: 'POST',
        body: formData,
        headers: {
          'Accept': 'application/json'
        }
      });
      
      if (response.ok) {
        document.getElementById('popup-newsletter-form')?.classList.add('hidden');
        document.getElementById('popup-success')?.classList.remove('hidden');
        
        if (typeof gtag !== 'undefined') {
          gtag('event', 'newsletter_signup', {
            location: 'popup',
            value: 5,
          });
        }
        
        setTimeout(closePopup, 3000);
      }
    } catch (error) {
      console.error('Form submission error:', error);
    }
  });
</script>
